<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONC - PARTE 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0c0a1a;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 20px 20px;
            touch-action: manipulation;
            overflow-y: auto;
        }
        .main-container {
            background: linear-gradient(170deg, #1e1b4b 0%, #0c0a1a 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .option-button {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s;
            border-bottom-width: 4px;
        }
        .option-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .option-button:active {
            transform: translateY(-1px);
        }
        #feedback {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .screen {
            min-height: 100vh;
            width: 100%;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .video-container { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            max-width: 100%; 
            background: #000; 
            border-radius: 1rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        .video-container iframe { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="main-container">

    <!-- Tela de Login / Cadastro -->
    <div id="login-screen" class="screen">
        <div class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl max-w-md w-full text-center text-white">
            <div id="login-form">
                <h1 class="text-3xl sm:text-4xl font-bold text-violet-300">Acessar Jogo</h1>
                <p class="text-violet-200 mt-4">Digite seu código e senha para entrar.</p>
                <input type="text" id="login-code" placeholder="Seu código" class="mt-8 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <input type="password" id="login-password" placeholder="Sua senha" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <button id="login-button" class="mt-6 w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-2xl font-bold py-3 rounded-xl shadow-lg hover:shadow-purple-500/50 transition flex items-center justify-center option-button border-purple-700">
                    <span class="button-text">Entrar</span>
                    <div class="loader hidden ml-3"></div>
                </button>
                <p id="login-message" class="text-red-400 mt-4 h-5"></p>
                <div class="flex space-x-2 mt-2">
                    <button id="go-to-register" class="w-1/2 text-violet-300 hover:underline">Não tenho cadastro</button>
                    <button id="view-ranking-button" class="w-1/2 text-violet-300 hover:underline">Ver Ranking</button>
                </div>
            </div>
            <div id="register-form" class="hidden">
                <h1 class="text-3xl sm:text-4xl font-bold text-violet-300">Criar Cadastro</h1>
                <p class="text-violet-200 mt-4">Preencha seus dados para criar um acesso.</p>
                <input type="text" id="register-name" placeholder="Nome Completo" class="mt-8 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <select id="register-class" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                    <option value="" class="text-black">Selecione sua turma</option>
                    <option value="5º Ano A" class="text-black">5º Ano A</option>
                    <option value="5º Ano B" class="text-black">5º Ano B</option>
                </select>
                <input type="text" id="register-code" placeholder="Crie um código de acesso" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <input type="password" id="register-password" placeholder="Crie uma senha" class="mt-4 w-full text-xl p-3 rounded-xl border-2 border-violet-400 bg-white/10 placeholder-violet-300">
                <button id="register-button" class="mt-6 w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white text-2xl font-bold py-3 rounded-xl shadow-lg hover:shadow-green-500/50 transition flex items-center justify-center option-button border-green-700">
                    <span class="button-text">Cadastrar e Entrar</span>
                    <div class="loader hidden ml-3"></div>
                </button>
                <p id="register-message" class="text-red-400 mt-4 h-5"></p>
                <button id="back-to-login" class="mt-2 text-violet-300 hover:underline">Já tenho cadastro</button>
            </div>
        </div>
    </div>

    <!-- Tela do Vídeo -->
    <div id="video-screen" class="screen hidden">
        <div class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl max-w-3xl w-full text-center text-white">
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-violet-300">Vamos aprender!</h2>
            <p class="text-base sm:text-lg text-violet-200 mt-2 mb-4">Assista ao vídeo para revisar e ganhar até 1000 pontos!</p>
            <div class="mb-4 bg-white/10 rounded-full px-6 py-2 inline-block">
                <span class="text-2xl font-semibold text-violet-200">Pontos: <span class="score-display">0</span></span>
            </div>
            <div class="video-container">
                <div id="player"></div>
            </div>
            <button id="continue-btn" class="mt-8 w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white text-2xl sm:text-3xl font-bold py-3 sm:py-4 rounded-xl shadow-lg transition transform hover:shadow-green-500/50 opacity-50 cursor-not-allowed option-button border-green-700" disabled>
                Ir para o Jogo!
            </button>
            <button id="skip-video-btn" class="mt-2 text-gray-400 hover:text-gray-200 hover:underline">Pular vídeo (não ganha pontos)</button>
        </div>
    </div>

    <!-- Tela do Jogo (Quiz) -->
    <div id="game-screen" class="screen hidden">
        <div class="w-full max-w-4xl">
             <header class="text-center mb-4 sm:mb-8 w-full">
                 <div class="flex justify-center items-center w-full">
                     <div class="glass-card rounded-full px-4 sm:px-6 py-2">
                         <span class="text-xl sm:text-2xl font-semibold text-violet-200">Pontos: <span class="score-display">0</span></span>
                     </div>
                 </div>
                 <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mt-4" style="text-shadow: 0 0 15px rgba(167, 139, 250, 0.7);">
                     ONC - PARTE 1
                 </h1>
                  <p class="text-lg sm:text-xl text-violet-300 mt-2">Olá, <span id="player-firstname"></span>! Escolha a resposta certa.</p>
             </header>
            <main class="w-full glass-card p-6 sm:p-8 rounded-2xl shadow-xl text-center">
                <div id="question-container" class="mb-6 sm:mb-8 text-xl sm:text-2xl md:text-3xl font-semibold text-white min-h-[6rem] flex items-center justify-center">
                    <!-- A pergunta aparecerá aqui -->
                </div>
                <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <!-- As opções aparecerão aqui -->
                </div>
            </main>
        </div>
    </div>

    <!-- Tela Final (Game Over) -->
    <div id="end-screen" class="screen hidden">
        <div class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl max-w-3xl w-full text-center my-8 text-white">
            <div id="end-screen-content">
                <h1 class="text-3xl sm:text-4xl font-bold text-violet-300">Fim de Jogo!</h1>
                <p id="final-message" class="text-lg text-violet-200 mt-4 font-semibold"></p>
                <p id="bonus-message" class="text-lg text-green-400 mt-2 font-semibold"></p>
                <div class="flex justify-center items-center my-6 text-violet-200">
                    <div class="text-xl"><strong>Pontos:</strong> <span id="final-score">0</span></div>
                </div>
            </div>
            <h2 class="text-2xl sm:text-3xl font-bold text-violet-300 mt-6 mb-4">Ranking (Top 100)</h2>
            <div class="overflow-y-auto h-64 bg-white/5 rounded-lg">
                <table class="w-full text-left">
                    <thead class="bg-white/10 sticky top-0">
                        <tr>
                            <th class="p-2">#</th>
                            <th class="p-2">Nome</th>
                            <th class="p-2">Pontos</th>
                            <th class="p-2">Turma</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <tr><td colspan="4" class="p-8 text-center"><div class="loader mx-auto"></div></td></tr>
                    </tbody>
                </table>
            </div>
            <button id="play-again-button" class="mt-8 w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white text-2xl sm:text-3xl font-bold py-3 rounded-xl shadow-lg hover:shadow-yellow-500/50 transition option-button border-yellow-700">
                Jogar Novamente
            </button>
            <button id="back-from-ranking-button" class="mt-8 w-full bg-gray-500 text-white text-2xl sm:text-3xl font-bold py-3 rounded-xl shadow-lg hover:bg-gray-600 transition hidden option-button border-gray-700">
                Voltar
            </button>
        </div>
    </div>

    <div id="feedback" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 sm:p-8 rounded-2xl text-white text-2xl font-bold shadow-2xl opacity-0 pointer-events-none w-11/12 max-w-sm text-center"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvzdtou17UCu8lmOFg9fxVEaLg1FnWcvexCYUZzqNLcUhiE6mZW_OkxeeI874AXZRT/exec';
        const NOME_DESTE_JOGO = "ONC - PARTE 1";

        // --- ELEMENTOS DO DOM ---
        const loginScreen = document.getElementById('login-screen');
        const videoScreen = document.getElementById('video-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const continueBtn = document.getElementById('continue-btn');
        const skipVideoBtn = document.getElementById('skip-video-btn');
        const loginForm = document.getElementById('login-form');
        const loginCodeInput = document.getElementById('login-code');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginMessage = document.getElementById('login-message');
        const goToRegisterButton = document.getElementById('go-to-register');
        const registerForm = document.getElementById('register-form');
        const registerNameInput = document.getElementById('register-name');
        const registerClassInput = document.getElementById('register-class');
        const registerCodeInput = document.getElementById('register-code');
        const registerPasswordInput = document.getElementById('register-password');
        const registerButton = document.getElementById('register-button');
        const registerMessage = document.getElementById('register-message');
        const backToLoginButton = document.getElementById('back-to-login');
        const playerFirstNameEl = document.getElementById('player-firstname');
        const finalMessageEl = document.getElementById('final-message');
        const viewRankingButton = document.getElementById('view-ranking-button');
        const backFromRankingButton = document.getElementById('back-from-ranking-button');
        const playAgainButton = document.getElementById('play-again-button');
        const endScreenContent = document.getElementById('end-screen-content');
        const questionContainer = document.getElementById('question-container');
        const optionsContainer = document.getElementById('options-container');
        const feedbackEl = document.getElementById('feedback');
        const bonusMessageEl = document.getElementById('bonus-message');

        // --- ESTADO DO JOGO ---
        let score = 0;
        let startTime;
        let loggedInUser = null;
        let videoPointsInvalidated = false;
        let currentQuestionIndex = 0;
        let shuffledQuestions = [];

        // --- BANCO DE PERGUNTAS COM EXPLICAÇÕES E PONTOS ---
        const questions = [
            // Matéria e Estados Físicos (10 Pontos)
            { question: 'O que é matéria?', options: ['É tudo o que brilha no escuro.', 'É tudo o que é macio e fofo.', 'É tudo aquilo que ocupa lugar no espaço e possui massa.', 'É apenas o que podemos ver e tocar.', 'É somente o que é líquido.'], answer: 'É tudo aquilo que ocupa lugar no espaço e possui massa.', explanation: 'Matéria é definida como tudo aquilo que ocupa lugar no espaço e possui massa, abrangendo todos os objetos ao nosso redor, desde o ar até o nosso corpo.', points: 10 },
            { question: 'Qual das opções abaixo é uma propriedade física da matéria que pode ser observada sem mudar sua composição química?', options: ['Ferver a água para virar vapor.', 'Queimar a madeira para virar cinzas.', 'Amassar um papel.', 'Misturar vinagre com bicarbonato.', 'Cozinhar um ovo.'], answer: 'Amassar um papel.', explanation: 'Amassar um papel é uma mudança na forma, mas a composição química do papel continua a mesma. A maleabilidade ou a capacidade de ser amassado é uma propriedade física.', points: 10 },
            { question: 'Qual propriedade física descreve a quantidade de matéria que um objeto possui?', options: ['Volume', 'Densidade', 'Temperatura', 'Cor', 'Massa'], answer: 'Massa', explanation: 'Massa é a quantidade de matéria que um objeto possui.', points: 10 },
            { question: 'Para identificar se um material é liso, áspero, macio ou duro, qual sentido podemos usar?', options: ['Visão', 'Olfato', 'Audição', 'Tato', 'Paladar'], answer: 'Tato', explanation: 'O tato é o sentido utilizado para sentir a textura, temperatura e dureza dos materiais.', points: 10 },
            { question: 'Um objeto que mantém sua forma definida mesmo quando mudamos de recipiente está em qual estado físico?', options: ['Líquido', 'Gasoso', 'Plasma', 'Sólido', 'Vaporoso'], answer: 'Sólido', explanation: 'No estado sólido, as partículas estão próximas e organizadas, fazendo com que o material tenha forma e volume definidos e mantenha sua forma.', points: 10 },
            { question: 'No estado gasoso, como as partículas da matéria se comportam?', options: ['Estão muito próximas e organizadas, vibrando no lugar.', 'Estão próximas, mas podem se mover, deslizando umas sobre as outras.', 'Estão distantes e se movem rapidamente por todo o espaço.', 'Estão congeladas e imóveis.', 'Não existem partículas no estado gasoso.'], answer: 'Estão distantes e se movem rapidamente por todo o espaço.', explanation: 'No estado gasoso, as partículas estão distantes umas das outras e se movem rapidamente, ocupando todo o espaço disponível.', points: 10 },
            { question: 'Qual dos exemplos a seguir representa a água no estado sólido?', options: ['Rios e lagos', 'Chuva e suco', 'Vapor que sai da chaleira', 'Gelo e neve', 'Nuvens'], answer: 'Gelo e neve', explanation: 'Gelo, geleiras, granizo e neve são exemplos de água no estado sólido.', points: 10 },
            { question: 'Em qual faixa de temperatura a água se encontra no estado líquido (ao nível do mar)?', options: ['Abaixo de 0°C', 'Acima de 100°C', 'Entre 0°C e 100°C', 'Somente a 0°C', 'Somente a 100°C'], answer: 'Entre 0°C e 100°C', explanation: 'A água se encontra no estado líquido em temperaturas entre 0°C e 100°C ao nível do mar.', points: 10 },
            { question: 'Quando o gelo derrete e vira água, qual mudança de estado está ocorrendo?', options: ['Solidificação', 'Vaporização', 'Condensação', 'Sublimação', 'Fusão'], answer: 'Fusão', explanation: 'A fusão é a mudança de estado do sólido para o líquido, como o gelo derretendo.', points: 10 },
            { question: 'Qual fator é o principal responsável pelas mudanças de estado da matéria?', options: ['Cor do material', 'Textura', 'Temperatura', 'Volume', 'Densidade'], answer: 'Temperatura', explanation: 'A temperatura, ou o fornecimento/retirada de energia (calor), é o principal fator que causa as mudanças de estado da matéria.', points: 10 },
            // Ciclo da Água e Meio Ambiente (20 Pontos)
            { question: 'O que é o ciclo da água?', options: ['O caminho da água dentro de uma torneira.', 'O movimento da água somente nos oceanos.', 'A transformação da água em gelo e vapor, sem retornar.', 'O movimento contínuo da água na natureza através dos três estados físicos.', 'A água que usamos para tomar banho e lavar louça.'], answer: 'O movimento contínuo da água na natureza através dos três estados físicos.', explanation: 'O ciclo da água é o movimento contínuo da água na natureza, passando pelos estados sólido, líquido e gasoso.', points: 20 },
            { question: 'Qual etapa do ciclo da água é quando o vapor sobe, esfria e forma as nuvens?', options: ['Evaporação', 'Transpiração', 'Precipitação', 'Infiltração', 'Condensação'], answer: 'Condensação', explanation: 'Condensação é a etapa em que o vapor d\'água na atmosfera esfria e se transforma em pequenas gotículas ou cristais de gelo, formando as nuvens.', points: 20 },
            { question: 'Por que o ciclo da água é fundamental para a vida na Terra?', options: ['Porque ele causa as enchentes.', 'Porque ele cria as secas.', 'Porque ele move os continentes.', 'Porque ele distribui água doce, regula a temperatura e permite ecossistemas.', 'Porque ele só existe em rios e lagos.'], answer: 'Porque ele distribui água doce, regula a temperatura e permite ecossistemas.', explanation: 'O ciclo da água é essencial porque distribui água doce pelo planeta, regula a temperatura global, permite a existência de ecossistemas e fornece água para consumo e agricultura.', points: 20 },
            { question: 'Como o ciclo da água influencia o clima de uma região?', options: ['Apenas pela quantidade de sol.', 'Determinando as chuvas, a temperatura e a umidade do ar.', 'Fazendo os rios secarem.', 'Criando montanhas.', 'Não tem influência no clima, só no nível da água.'], answer: 'Determinando as chuvas, a temperatura e a umidade do ar.', explanation: 'O ciclo da água influencia o clima diretamente através das chuvas (que determinam se uma região é seca ou úmida), da temperatura (a evaporação resfria o ambiente) e da umidade do ar.', points: 20 },
            { question: 'Qual das seguintes atividades humanas NÃO é um impacto negativo no meio ambiente relacionado ao ciclo da água?', options: ['Desmatamento', 'Urbanização com muito concreto', 'Poluição de rios', 'Reflorestamento', 'Uso excessivo de agrotóxicos'], answer: 'Reflorestamento', explanation: 'Reflorestamento é uma solução positiva, pois plantar árvores ajuda a restaurar a vegetação, favorecendo a transpiração, a infiltração e a proteção do solo, contribuindo para a saúde do ciclo da água.', points: 20 },
            { question: 'Qual a principal função das raízes das plantas em relação à água no solo?', options: ['Liberar vapor d\'água para a atmosfera.', 'Captar a chuva antes de chegar ao solo.', 'Criar caminhos para a água penetrar no solo.', 'Produzir oxigênio.', 'Deixar o solo sem nutrientes.'], answer: 'Criar caminhos para a água penetrar no solo.', explanation: 'As raízes das plantas criam canais e descompactam o solo, facilitando a infiltração da água e contribuindo para a formação de lençóis freáticos.', points: 20 },
            { question: 'A fotossíntese é o processo pelo qual as plantas usam água, gás carbônico e luz solar para produzir o quê?', options: ['Apenas vapor d\'água.', 'Oxigênio e glicose (energia para a planta).', 'Somente gás carbônico.', 'Poluentes para o ar.', 'Somente água e luz.'], answer: 'Oxigênio e glicose (energia para a planta).', explanation: 'As plantas usam água, gás carbônico e luz solar na fotossíntese para produzir oxigênio (que respiramos) e glicose (que é a energia para a planta).', points: 20 },
            { question: 'Qual a consequência do desmatamento para o ciclo da água e o meio ambiente?', options: ['Aumento das chuvas regionais.', 'Menor risco de enchentes.', 'Redução das chuvas e aumento da erosão do solo.', 'Mais infiltração de água no solo.', 'O solo fica mais protegido.'], answer: 'Redução das chuvas e aumento da erosão do solo.', explanation: 'O desmatamento remove a cobertura vegetal, o que reduz a transpiração das plantas (diminuindo a formação de nuvens e chuvas) e deixa o solo desprotegido, vulnerável à erosão pela água e vento.', points: 20 },
            { question: 'Para conservar o solo e evitar a erosão, uma prática agrícola importante é:', options: ['Plantar sempre a mesma cultura.', 'Deixar o solo descoberto.', 'Usar somente adubos químicos.', 'Plantar seguindo as curvas de nível do terreno.', 'Queimar o solo antes de plantar.'], answer: 'Plantar seguindo as curvas de nível do terreno.', explanation: 'Plantar seguindo as curvas de nível do terreno ajuda a reduzir a velocidade da água da chuva, diminuindo a erosão e favorecendo a infiltração.', points: 20 },
            { question: 'Qual ação ajuda na conservação da água?', options: ['Deixar a torneira aberta enquanto escova os dentes.', 'Não tratar o esgoto antes de jogar nos rios.', 'Desperdiçar água lavando calçadas com mangueira.', 'Proteger as nascentes dos rios mantendo a vegetação ao redor.', 'Usar água potável para regar plantas no jardim.'], answer: 'Proteger as nascentes dos rios mantendo a vegetação ao redor.', explanation: 'Proteger as nascentes dos rios, mantendo a vegetação em suas margens, é fundamental para preservar a qualidade e a quantidade da água disponível.', points: 20 },
             // Sustentabilidade (30 Pontos)
            { question: 'Como a cobertura vegetal (plantas) se relaciona com a qualidade do ar?', options: ['Ela apenas libera gás carbônico para o ar.', 'Não tem nenhuma relação com o ar.', 'Absorve oxigênio e libera poluentes.', 'Filtra poeira, absorve CO2 e libera oxigênio.', 'Aumenta a temperatura do ar.'], answer: 'Filtra poeira, absorve CO2 e libera oxigênio.', explanation: 'A vegetação melhora a qualidade do ar filtrando poeira e poluentes pelas folhas, absorvendo gás carbônico e liberando oxigênio essencial para a respiração.', points: 30 },
            { question: 'Qual o impacto da transpiração das plantas no ciclo da água?', options: ['Ela faz a água infiltrar mais rápido no solo.', 'Ela protege o solo da erosão.', 'Ela libera vapor d\'água, contribuindo para a formação de nuvens e chuvas.', 'Ela retém a água nas folhas, impedindo-a de retornar ao ciclo.', 'Ela aumenta a temperatura do ambiente.'], answer: 'Ela libera vapor d\'água, contribuindo para a formação de nuvens e chuvas.', explanation: 'A transpiração das plantas libera vapor d\'água para a atmosfera, um processo crucial que contribui significativamente para a umidade do ar e a formação de nuvens e chuvas.', points: 30 },
            { question: 'Qual é um uso doméstico importante da água em nossa rotina diária?', options: ['Gerar eletricidade em hidrelétricas.', 'Refrigerar máquinas em fábricas.', 'Cozinhar alimentos e para higiene pessoal.', 'Irrigar grandes plantações.', 'Navegar em rios e oceanos.'], answer: 'Cozinhar alimentos e para higiene pessoal.', explanation: 'Cozinhar alimentos, beber e a higiene pessoal (banho, escovação) são usos domésticos essenciais da água.', points: 30 },
            { question: 'Qual tipo de material é considerado um recurso renovável?', options: ['Plástico', 'Minério de ferro', 'Petróleo', 'Madeira', 'Vidro'], answer: 'Madeira', explanation: 'A madeira, proveniente de árvores, é um recurso renovável se for manejada de forma sustentável, com replantio.', points: 30 },
            { question: 'O que significa o princípio da sustentabilidade "Renovabilidade"?', options: ['Construir edifícios muito antigos.', 'Usar apenas materiais que não acabam nunca.', 'Preferir recursos que se regeneram naturalmente.', 'Fazer produtos que duram pouco.', 'Gastar mais água e energia.'], answer: 'Preferir recursos que se regeneram naturalmente.', explanation: 'O princípio da renovabilidade na sustentabilidade significa dar preferência a recursos que podem se regenerar ou ser repostos pela natureza em um período de tempo razoável, como a madeira de florestas manejadas ou a energia solar.', points: 30 },
            { question: 'Qual das opções representa uma prática de consumo consciente?', options: ['Comprar muitas roupas baratas que logo serão descartadas.', 'Escolher produtos com muitas embalagens para proteger melhor.', 'Preferir produtos locais e que tenham menor impacto ambiental.', 'Comprar sempre o que está na moda, mesmo sem precisar.', 'Desperdiçar alimentos porque são baratos.'], answer: 'Preferir produtos locais e que tenham menor impacto ambiental.', explanation: 'O consumo consciente envolve escolher produtos que satisfazem nossas necessidades, considerando sua qualidade, origem (preferindo locais para reduzir transporte) e o menor impacto ambiental de sua produção.', points: 30 },
            { question: 'A conservação dos recursos naturais é um investimento no futuro porque:', options: ['Garante que os recursos estarão disponíveis apenas para quem pode pagar.', 'Permite que os recursos sejam usados sem limites.', 'Garante que os recursos estarão disponíveis para as próximas gerações.', 'Apenas evita a poluição.', 'É uma ideia antiga que não se aplica mais.'], answer: 'Garante que os recursos estarão disponíveis para as próximas gerações.', explanation: 'A conservação dos recursos naturais é um investimento no futuro, pois garante que eles estarão disponíveis para as necessidades das próximas gerações, mantendo o equilíbrio ambiental e a qualidade de vida.', points: 30 },
            { question: 'Qual é a ordem de prioridade correta dos 3Rs (Redução, Reutilização e Reciclagem)?', options: ['Reciclar, Reutilizar, Reduzir.', 'Reutilizar, Reciclar, Reduzir.', 'Reduzir, Reutilizar, Reciclar.', 'Reciclar, Reduzir, Reutilizar.', 'Reutilizar, Reduzir, Reciclar.'], answer: 'Reduzir, Reutilizar, Reciclar.', explanation: 'A ordem de prioridade dos 3Rs é sempre: primeiro Reduzir (diminuir o consumo e a geração de lixo), depois Reutilizar (usar novamente produtos ou materiais) e, por fim, Reciclar (transformar materiais usados em novos produtos).', points: 30 },
            { question: 'Um exemplo prático de Redução no consumo de água é:', options: ['Tomar banhos demorados.', 'Usar a mangueira para lavar o carro.', 'Instalar torneiras economizadoras em casa.', 'Deixar o chuveiro ligado enquanto se ensaboa.', 'Regar o jardim todos os dias em horários de sol forte.'], answer: 'Instalar torneiras economizadoras em casa.', explanation: 'Instalar torneiras e chuveiros com sistemas que reduzem o fluxo de água, como as torneiras economizadoras, é uma forma de reduzir o consumo sem abrir mão do conforto.', points: 30 },
            { question: 'Qual é um exemplo de Reutilização de materiais no dia a dia?', options: ['Jogar todas as embalagens no lixo comum.', 'Comprar uma garrafa de água nova a cada vez que sentir sede.', 'Usar potes de vidro vazios para guardar temperos ou outros alimentos.', 'Descartar roupas velhas em vez de doá-las.', 'Queimar o lixo em casa.'], answer: 'Usar potes de vidro vazios para guardar temperos ou outros alimentos.', explanation: 'Reutilizar potes de vidro, caixas, garrafas ou outros objetos que teriam como destino o lixo para novas funções (como guardar alimentos, organizar ou decorar) é um excelente exemplo de reutilização.', points: 30 },
            // Lixo e Projetos Escolares (40 Pontos)
            { question: 'Qual é o objetivo principal da Reciclagem?', options: ['Acabar com todos os recursos naturais.', 'Diminuir a quantidade de lixo em aterros e economizar recursos.', 'Aumentar a produção de lixo.', 'Fabricar apenas produtos novos sem usar nada antigo.', 'Poluir mais o meio ambiente.'], answer: 'Diminuir a quantidade de lixo em aterros e economizar recursos.', explanation: 'A reciclagem tem como objetivo principal transformar materiais que seriam descartados em novos produtos, diminuindo assim a quantidade de lixo enviada para aterros sanitários e economizando recursos naturais e energia necessários para produzir novos materiais.', points: 40 },
            { question: 'Qual das seguintes é uma tecnologia sustentável para geração de energia?', options: ['Usina termelétrica a carvão.', 'Gerador a diesel.', 'Painéis solares fotovoltaicos.', 'Reator nuclear.', 'Queima de gás natural.'], answer: 'Painéis solares fotovoltaicos.', explanation: 'Os painéis solares fotovoltaicos captam a energia do sol para gerar eletricidade de forma limpa e renovável, sendo um exemplo de tecnologia sustentável.', points: 40 },
            { question: 'Um bom exemplo de construção sustentável é:', options: ['Usar muitos materiais de plástico e cimento.', 'Ter muitas janelas sem isolamento térmico.', 'Construir casas com bambu e sistemas de captação de água da chuva.', 'Fazer uma casa sem nenhuma ventilação natural.', 'Usar muita energia para aquecer ou resfriar.'], answer: 'Construir casas com bambu e sistemas de captação de água da chuva.', explanation: 'Construções sustentáveis utilizam materiais ecológicos (como bambu e madeira certificada), têm eficiência energética (isolamento térmico, ventilação natural) e aproveitam a água (cisternas, jardins de chuva).', points: 40 },
            { question: 'Qual tipo de lixo é composto por restos de comida, folhas e materiais que se decompõem naturalmente?', options: ['Lixo eletrônico', 'Lixo perigoso', 'Lixo reciclável', 'Lixo orgânico', 'Lixo de metal'], answer: 'Lixo orgânico', explanation: 'Lixo orgânico é formado por restos de comida, cascas de frutas, folhas, podas de jardim e outros materiais biodegradáveis.', points: 40 },
            { question: 'Qual é uma solução para o problema do lixo que transforma restos de comida em adubo para plantas?', options: ['Queima de lixo', 'Aterros sanitários', 'Coleta seletiva', 'Compostagem', 'Descarte em rios'], answer: 'Compostagem', explanation: 'A compostagem é o processo de transformar lixo orgânico (restos de comida, cascas, folhas) em adubo rico em nutrientes, chamado húmus, que pode ser usado para fertilizar plantas.', points: 40 },
            { question: 'Qual é o tempo de decomposição aproximado de uma lata de alumínio na natureza?', options: ['1 a 6 meses', '3 a 6 meses', '1 a 2 anos', '200 a 500 anos', 'Mais de 1000 anos'], answer: '200 a 500 anos', explanation: 'Latas de alumínio levam de 200 a 500 anos para se decompor na natureza, o que mostra a importância da reciclagem.', points: 40 },
            { question: 'Qual o objetivo de um projeto de Horta Escolar de Sustentabilidade?', options: ['Apenas embelezar a escola.', 'Produzir alimentos de forma sustentável e aprender sobre a natureza.', 'Aumentar o consumo de água na escola.', 'Fazer o solo ficar sem nutrientes.', 'Produzir somente lixo orgânico.'], answer: 'Produzir alimentos de forma sustentável e aprender sobre a natureza.', explanation: 'O objetivo da horta escolar é produzir alimentos de forma sustentável (usando compostagem, adubação orgânica) e, ao mesmo tempo, permitir que os alunos aprendam sobre fotossíntese, ciclo da água, nutrição vegetal e responsabilidade ambiental.', points: 40 },
            { question: 'Qual a utilidade da Captação de Água da Chuva em um projeto escolar?', options: ['Para beber a água da chuva diretamente.', 'Para usar na lavagem de carros.', 'Para aproveitar a água pluvial na irrigação de plantas ou limpeza externa.', 'Para fazer o telhado da escola ter vazamentos.', 'Para aumentar a conta de água.'], answer: 'Para aproveitar a água pluvial na irrigação de plantas ou limpeza externa.', explanation: 'O projeto de captação de água da chuva tem como objetivo aproveitar a precipitação para usos não potáveis, como regar plantas na horta escolar ou para limpeza externa, economizando água tratada.', points: 40 },
            { question: 'O que é o húmus, produzido na composteira?', options: ['Um tipo de lixo que não serve para nada.', 'Um produto químico para matar pragas.', 'Um adubo orgânico para fertilizar plantas.', 'Um material que polui o solo.', 'Uma mistura de lixo eletrônico.'], answer: 'Um adubo orgânico para fertilizar plantas.', explanation: 'O húmus é o produto final da compostagem, um adubo orgânico de alta qualidade, rico em nutrientes, que melhora o solo e serve para fertilizar plantas.', points: 40 },
            { question: 'Qual o principal objetivo de uma Campanha de Conscientização ambiental em uma escola?', options: ['Apenas fazer cartazes bonitos.', 'Ignorar os problemas ambientais.', 'Educar a comunidade sobre a importância da sustentabilidade e ações práticas.', 'Vender produtos da escola.', 'Plantar árvores sem planejamento.'], answer: 'Educar a comunidade sobre a importância da sustentabilidade e ações práticas.', explanation: 'O principal objetivo de uma campanha de conscientização é educar a comunidade (alunos, pais, funcionários) sobre os problemas ambientais, a importância da sustentabilidade e inspirar ações práticas para a conservação e o consumo consciente.', points: 40 },
             // Impactos Ambientais e Energia (40 Pontos)
            { question: 'Qual o problema ambiental causado pelo cimento e asfalto nas cidades?', options: ['Aumento da infiltração da água no solo.', 'Diminuição das enchentes.', 'Impedimento da infiltração da água no solo e aumento do escoamento superficial.', 'Aumento da área verde.', 'Diminuição da temperatura do ambiente.'], answer: 'Impedimento da infiltração da água no solo e aumento do escoamento superficial.', explanation: 'O cimento e o asfalto nas áreas urbanas tornam o solo impermeável, impedindo a infiltração da água da chuva. Isso aumenta o escoamento superficial, sobrecarrega os sistemas de drenagem e contribui para as enchentes.', points: 40 },
            { question: 'Qual a importância das hidrelétricas para a geração de energia?', options: ['Elas usam combustíveis fósseis para gerar eletricidade.', 'Elas aproveitam a força do vento.', 'Elas utilizam a força da água em movimento para gerar eletricidade.', 'Elas produzem energia nuclear.', 'Elas queimam biomassa.'], answer: 'Elas utilizam a força da água em movimento para gerar eletricidade.', explanation: 'As hidrelétricas são usinas que geram eletricidade utilizando a força da água em movimento, geralmente de rios represados, sendo uma fonte de energia renovável.', points: 40 },
            { question: 'Para que servem os reservatórios de água em relação ao abastecimento humano?', options: ['Para poluir a água antes do tratamento.', 'Para captar e armazenar água da chuva, formando reservas.', 'Para evaporar a água e formar nuvens.', 'Para desviar a água dos rios para outras regiões.', 'Para aumentar a quantidade de esgoto.'], answer: 'Para captar e armazenar água da chuva, formando reservas.', explanation: 'Os reservatórios têm a função de captar e armazenar a água da chuva e de rios, formando grandes reservas que são depois tratadas e distribuídas para o consumo humano, a agricultura e a indústria.', points: 40 },
            { question: 'A biodiversidade nos ecossistemas é afetada pela água de que maneira?', options: ['Apenas pela poluição.', 'Diferentes quantidades de água criam habitats variados para espécies diferentes.', 'A água faz os animais migrarem para longe das plantas.', 'Apenas pela temperatura da água.', 'A água não tem relação com a biodiversidade.'], answer: 'Diferentes quantidades de água criam habitats variados para espécies diferentes.', explanation: 'A disponibilidade e quantidade de água em um ecossistema são fatores cruciais que determinam a diversidade de habitats e, consequentemente, a biodiversidade de espécies vegetais e animais que podem viver naquela região.', points: 40 },
            { question: 'Qual a função da vegetação para a proteção do solo?', options: ['Aumentar a erosão.', 'Deixar o solo exposto ao sol.', 'Evitar a erosão causada pela chuva e vento.', 'Impedir a entrada de água no solo.', 'Retirar todos os nutrientes do solo.'], answer: 'Evitar a erosão causada pela chuva e vento.', explanation: 'A vegetação atua como uma barreira protetora para o solo. As folhas e galhos interceptam a chuva, e as raízes fixam o solo, evitando que ele seja levado pela água (erosão pluvial) ou pelo vento (erosão eólica).', points: 40 },
            { question: 'O que as "ilhas de calor" em pátios de escolas (ou cidades) significam?', options: ['Lugares onde há muitas plantas e árvores.', 'Áreas com temperatura mais baixa devido à ventilação.', 'Áreas com maior concentração de cimento e asfalto, elevando a temperatura.', 'Locais onde a água evapora muito rápido.', 'Regiões com muita sombra.'], answer: 'Áreas com maior concentração de cimento e asfalto, elevando a temperatura.', explanation: 'As ilhas de calor são fenômenos urbanos onde áreas com grande concentração de superfícies impermeáveis (cimento, asfalto) e pouca vegetação absorvem e retêm mais calor solar, resultando em temperaturas significativamente mais altas do que as áreas circundantes com mais verde.', points: 40 },
            { question: 'Um problema causado pelo lixo em rios e oceanos é:', options: ['O aumento da vida aquática.', 'A melhoria da qualidade da água.', 'A poluição e o prejuízo à vida aquática e aos ecossistemas.', 'A diminuição das enchentes.', 'A produção de adubo natural.'], answer: 'A poluição e o prejuízo à vida aquática e aos ecossistemas.', explanation: 'O lixo descartado em rios e oceanos causa poluição da água, prejudica gravemente a vida aquática (animais podem ingerir ou ficar presos em plásticos) e desequilibra os ecossistemas aquáticos.', points: 40 },
            { question: 'Qual é a principal forma de atuação do monitoramento ambiental em uma escola?', options: ['Apenas limpar o pátio uma vez por ano.', 'Acompanhar a qualidade ambiental da escola e propor melhorias.', 'Exclusivamente plantar árvores.', 'Gastar mais água e energia.', 'Ignorar o que acontece no ambiente da escola.'], answer: 'Acompanhar a qualidade ambiental da escola e propor melhorias.', explanation: 'O monitoramento ambiental em uma escola busca acompanhar e avaliar aspectos como consumo de água, produção de lixo, qualidade do ar e temperatura, para identificar problemas e propor ações e soluções para melhorar a sustentabilidade do ambiente escolar.', points: 40 },
            { question: 'Qual a relação entre o vento e o ciclo da água na geração de energia?', options: ['O vento não tem relação com o ciclo da água.', 'O vento é gerado pela evaporação da água e pode mover turbinas eólicas.', 'O vento apenas leva as nuvens para longe.', 'O vento aumenta o nível dos rios.', 'O vento congela a água.'], answer: 'O vento é gerado pela evaporação da água e pode mover turbinas eólicas.', explanation: 'O ciclo da água, com suas diferenças de temperatura e pressão causadas pela evaporação e condensação, contribui para a formação de ventos. Esses ventos, por sua vez, podem ser aproveitados para mover turbinas eólicas e gerar eletricidade, sendo uma forma de energia renovável.', points: 40 },
            { question: 'Por que as áreas verdes urbanas são importantes para o meio ambiente e o conforto térmico nas cidades?', options: ['Elas aumentam a temperatura do ambiente.', 'Elas causam mais poluição do ar.', 'Elas contribuem para a umidade do ar, sombra e regulação térmica.', 'Elas impedem a infiltração da água.', 'Elas atraem mais lixo.'], answer: 'Elas contribuem para a umidade do ar, sombra e regulação térmica.', explanation: 'As áreas verdes urbanas (parques, jardins) são cruciais porque as plantas, através da transpiração, aumentam a umidade do ar, proporcionam sombra e regulam a temperatura, tornando o ambiente mais fresco e agradável nas cidades, combatendo as ilhas de calor.', points: 40 }
        ];

        // --- FUNÇÕES GERAIS E DE TELA ---
        function showScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');
        }

        function toggleButtonLoader(button, show) {
            const buttonText = button.querySelector('.button-text');
            const loader = button.querySelector('.loader');
            if (buttonText && loader) {
                buttonText.style.display = show ? 'none' : 'inline';
                loader.style.display = show ? 'inline-block' : 'none';
            }
            button.disabled = show;
        }

        async function callAppsScript(action, data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify({ action, ...data })
                });
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                return await response.json();
            } catch (error) {
                console.error("Erro ao contatar o Apps Script:", error);
                return { status: 'error', message: 'Falha de comunicação. Verifique a publicação do script e sua conexão.' };
            }
        }
        
        function capitalizeName(name) {
            return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function handleSuccessfulLogin(userData) {
            const firstName = userData.name.split(' ')[0];
            loggedInUser = { ...userData, firstName };
            sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            playerFirstNameEl.textContent = firstName;
            showScreen(videoScreen);
        }

        // --- LÓGICA DE LOGIN E CADASTRO ---
        loginButton.addEventListener('click', async () => {
            const code = loginCodeInput.value.trim();
            const password = loginPasswordInput.value.trim();
            loginMessage.textContent = '';
            if (!code || !password) {
                loginMessage.textContent = 'Preencha o código e a senha.';
                return;
            }
            toggleButtonLoader(loginButton, true);
            const result = await callAppsScript('login', { code, password });
            toggleButtonLoader(loginButton, false);
            if (result.status === 'success') {
                handleSuccessfulLogin({ name: result.name, code: code, turma: result.turma });
            } else if (result.status === 'not_found') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                registerCodeInput.value = code;
                registerCodeInput.removeAttribute('readonly');
            } else {
                loginMessage.textContent = result.message || 'Ocorreu um erro.';
            }
        });
        
        goToRegisterButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            loginMessage.textContent = '';
            registerCodeInput.removeAttribute('readonly');
            registerCodeInput.value = '';
        });

        registerButton.addEventListener('click', async () => {
            const rawName = registerNameInput.value.trim();
            const turma = registerClassInput.value;
            const code = registerCodeInput.value.trim();
            const password = registerPasswordInput.value.trim();
            registerMessage.textContent = '';
            if (!rawName || !turma || !code || !password) {
                registerMessage.textContent = 'Todos os campos são obrigatórios.';
                return;
            }
            const name = capitalizeName(rawName);
            toggleButtonLoader(registerButton, true);
            const data = { name, turma, code, password };
            const result = await callAppsScript('register', data);
            toggleButtonLoader(registerButton, false);
            if (result.status === 'success') {
                handleSuccessfulLogin({ name: name, code: code, turma: turma });
            } else {
                registerMessage.textContent = result.message || 'Ocorreu um erro.';
            }
        });

        backToLoginButton.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            registerMessage.textContent = '';
        });

        loginPasswordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loginButton.click(); });
        loginCodeInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') loginButton.click(); });
        registerPasswordInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });
        registerCodeInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });
        registerNameInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') registerButton.click(); });

        window.addEventListener('load', () => {
            const user = sessionStorage.getItem('loggedInUser');
            if (user) {
                loggedInUser = JSON.parse(user);
                playerFirstNameEl.textContent = loggedInUser.firstName;
                showScreen(videoScreen);
            } else {
                showScreen(loginScreen);
            }
            updateScoreDisplay();
        });
        
        // --- LÓGICA DO VÍDEO ---
        let player;
        let progressCheckInterval;
        let maxWatchedTime = 0;

        function updateScoreDisplay() {
            document.querySelectorAll('.score-display').forEach(el => el.textContent = score);
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'uXpMSLSinE0',
                playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerReady(event) {
            maxWatchedTime = 0;
            videoPointsInvalidated = false;
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                clearInterval(progressCheckInterval); 
                progressCheckInterval = setInterval(() => {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    const isMuted = player.isMuted();
                    const playbackRate = player.getPlaybackRate();
                    const scoreTextEl = videoScreen.querySelector('.score-display').parentElement;

                    if (currentTime > maxWatchedTime + 1.5) {
                        player.seekTo(maxWatchedTime, true);
                    } else if (currentTime > maxWatchedTime) {
                        maxWatchedTime = currentTime;
                    }
                    
                    if (isMuted || playbackRate !== 1) {
                        videoPointsInvalidated = true;
                    }

                    if(videoPointsInvalidated) {
                        score = 0;
                        scoreTextEl.classList.add('text-red-500');
                    } else if (duration > 0) {
                        const potentialScore = (maxWatchedTime / duration) * 1000;
                        score = Math.floor(potentialScore / 10) * 10;
                        scoreTextEl.classList.remove('text-red-500');
                    }
                    updateScoreDisplay();

                    if ((maxWatchedTime / duration) >= 0.9) {
                        if (continueBtn.disabled) {
                            continueBtn.disabled = false;
                            continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }, 500);
            } else {
                clearInterval(progressCheckInterval);
            }
        }

        continueBtn.addEventListener('click', () => {
            if (!continueBtn.disabled) {
                showScreen(gameScreen);
                startGame();
            }
        });

        skipVideoBtn.addEventListener('click', () => {
            score = 0;
            updateScoreDisplay();
            showScreen(gameScreen);
            startGame();
        });

        // --- LÓGICA DO QUIZ ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            if(player && typeof player.stopVideo === 'function') {
                player.stopVideo();
            }
            currentQuestionIndex = 0;
            shuffledQuestions = shuffleArray([...questions]);
            startTime = new Date();
            updateScoreDisplay();
            displayNextQuestion();
        }

        function displayNextQuestion() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                endGame(true); // Finaliza o jogo se todas as questões foram respondidas
                return;
            }

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            questionContainer.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';

            const shuffledOptions = shuffleArray([...currentQuestion.options]);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button', 'w-full', 'bg-white/10', 'text-white', 'text-lg', 'sm:text-xl', 'font-bold', 'py-4', 'px-2', 'rounded-xl', 'shadow-lg', 'border-violet-400', 'hover:bg-violet-500/30');
                button.addEventListener('click', handleAnswer);
                optionsContainer.appendChild(button);
            });
        }

        function handleAnswer(e) {
            const selectedOption = e.target.textContent;
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer;
            const explanation = currentQuestion.explanation;

            optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                score += currentQuestion.points;
                showFeedback(`+${currentQuestion.points} Pontos! 🎉`, explanation, true);
                e.target.classList.remove('bg-white/10', 'border-violet-400', 'hover:bg-violet-500/30');
                e.target.classList.add('bg-green-500', 'border-green-700', 'text-white');
            } else {
                const wrongFeedbackMsg = `Ops! A resposta certa é "${correctAnswer}".`;
                showFeedback(wrongFeedbackMsg, explanation, false);
                 e.target.classList.remove('bg-white/10', 'border-violet-400', 'hover:bg-violet-500/30');
                e.target.classList.add('bg-red-500', 'border-red-700', 'text-white');
            }
            
            updateScoreDisplay();
            currentQuestionIndex++;
        }

        function showFeedback(message, explanation, isCorrect) {
            feedbackEl.innerHTML = `
                <strong class="block text-3xl mb-2">${message}</strong>
                <span class="text-xl mt-2 block font-normal">${explanation}</span>
                <button id="feedback-continue-btn" class="mt-6 w-full bg-white/20 text-white font-bold py-3 rounded-xl hover:bg-white/30 transition option-button border-white/30">Continuar →</button>
            `;
            
            const colorClass = isCorrect ? 'bg-gradient-to-br from-green-400 to-emerald-600' : 'bg-gradient-to-br from-red-400 to-rose-600';
            feedbackEl.className = `fixed z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 sm:p-8 rounded-2xl text-white text-2xl font-bold shadow-2xl w-11/12 max-w-sm text-center transition-all duration-300 ease-in-out ${colorClass} opacity-0 scale-90`;
            
            feedbackEl.classList.remove('pointer-events-none');
            
            requestAnimationFrame(() => {
                feedbackEl.classList.remove('opacity-0', 'scale-90');
            });

            const hideAndContinue = () => {
                feedbackEl.classList.add('opacity-0', 'scale-90', 'pointer-events-none');
                setTimeout(displayNextQuestion, 300); // Wait for animation
            };

            document.getElementById('feedback-continue-btn').addEventListener('click', hideAndContinue, { once: true });
        }
        
        function getMotivationalMessage(finalScore) {
            if (finalScore >= 1000) {
                return "Excelente, " + loggedInUser.firstName + "! Você domina a ciência! 🏆";
            } else if (finalScore >= 500) {
                return "Muito bem, " + loggedInUser.firstName + "! Continue praticando para ficar ainda melhor. 👍";
            } else {
                return "Não desista, " + loggedInUser.firstName + "! Cada tentativa é um passo para aprender mais. ✨";
            }
        }
        
        // --- LÓGICA DE FIM DE JOGO E RANKING ---
        function resetGame() {
            score = 0;
            currentQuestionIndex = 0;
            videoPointsInvalidated = false;
            maxWatchedTime = 0;
            startTime = null;

            updateScoreDisplay();
            
            if (player && typeof player.seekTo === 'function') {
                player.seekTo(0, true);
                player.stopVideo();
            }
            
            continueBtn.disabled = true;
            continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
            videoScreen.querySelector('.score-display').parentElement.classList.remove('text-red-500');

            showScreen(videoScreen);
        }

        async function endGame(allQuestionsAnswered = false) {
            let finalScore = score;
            bonusMessageEl.textContent = '';
            
            if (allQuestionsAnswered){
                 finalScore += 500; // Bônus por terminar todas as questões
                 bonusMessageEl.textContent = `+500 pontos de bônus por terminar o jogo!`;
            }

            const endTime = new Date();
            const timeSpent = Math.round((endTime - startTime) / 1000);
            
            showScreen(endScreen);
            endScreenContent.classList.remove('hidden');
            playAgainButton.classList.remove('hidden');
            backFromRankingButton.classList.add('hidden');
            document.getElementById('final-score').textContent = finalScore;
            finalMessageEl.textContent = getMotivationalMessage(finalScore);
            
            const result = await callAppsScript('saveScoreAndGetRanking', { 
                fullName: loggedInUser.name, 
                turma: loggedInUser.turma, 
                score: finalScore, 
                time: timeSpent,
                nomeDoJogo: NOME_DESTE_JOGO,
                code: loggedInUser.code
            });
            
            if (result.status === 'success') {
                populateRankingTable(result.ranking, loggedInUser.code);
            } else {
                document.getElementById('ranking-body').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">${result.message}</td></tr>`;
            }
        }
        
        async function displayRanking() {
            showScreen(endScreen);
            endScreenContent.classList.add('hidden');
            playAgainButton.classList.add('hidden');
            backFromRankingButton.classList.remove('hidden');

            const result = await callAppsScript('getRanking', { nomeDoJogo: NOME_DESTE_JOGO });
            if (result.status === 'success') {
                const userCode = loggedInUser ? loggedInUser.code : null;
                populateRankingTable(result.ranking, userCode);
            } else {
                document.getElementById('ranking-body').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">${result.message}</td></tr>`;
            }
        }

        viewRankingButton.addEventListener('click', displayRanking);
        
        backFromRankingButton.addEventListener('click', () => {
            showScreen(loginScreen);
        });

        function populateRankingTable(ranking, currentUserCode) {
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = '';
            if(!ranking || ranking.length === 0){
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Ainda não há pontuações. Seja o primeiro!</td></tr>`;
                return;
            }
            ranking.forEach((entry, index) => {
                const isCurrentUser = currentUserCode && entry.code === currentUserCode;
                const row = `
                    <tr class="border-b border-white/10 ${isCurrentUser ? 'bg-yellow-500/30' : ''}">
                        <td class="p-2 font-bold">${index + 1}</td>
                        <td class="p-2">${entry.name}</td>
                        <td class="p-2">${entry.score}</td>
                        <td class="p-2">${entry.turma}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        playAgainButton.addEventListener('click', resetGame);

    </script>
</body>
</html>

